<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC - Painel de Controle</title>
    
    <!-- Bibliotecas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIREBASE (O Cérebro) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Estilos do Mapa e Layout (Idêntico ao anterior) */
        body { font-family: sans-serif; height: 100vh; overflow: hidden; background-color: #f3f4f6; }
        #app-container { display: flex; height: 100vh; width: 100vw; }
        #sidebar { width: 420px; background: white; display: flex; flex-direction: column; border-right: 1px solid #e5e7eb; z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.05); }
        #map-wrapper { flex-grow: 1; position: relative; z-index: 10; }
        .custom-div-icon i { position: absolute; width: 22px; left: 0; right: 0; margin: 10px auto; text-align: center; font-size: 22px; }
        .timeline-item { position: relative; padding-left: 1.5rem; padding-bottom: 1.5rem; border-left: 2px dashed #cbd5e1; margin-left: 10px; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -0.42rem; top: 0.2rem; width: 1rem; height: 1rem; border-radius: 50%; background: white; border: 2px solid #3b82f6; z-index: 10; }
        .timeline-dot.completed { background-color: #10b981; border-color: #10b981; color: white; }
        .loader-overlay { background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); }
        .driver-card.selected { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- SIDEBAR -->
        <aside id="sidebar">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg"><i class="fas fa-satellite-dish text-lg"></i></div>
                    <div><h1 class="font-bold text-slate-800 text-lg">SGC - Nuvem</h1><p class="text-xs text-green-600 font-bold">● Online</p></div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="px-5 pt-4 flex gap-4 border-b border-slate-100">
                <button onclick="switchTab('planning')" class="tab-btn flex-1 pb-3 text-sm font-bold border-b-2 border-blue-600 text-blue-600">Planejar</button>
                <button onclick="switchTab('list')" class="tab-btn flex-1 pb-3 text-sm font-bold border-b-2 border-transparent text-slate-400">Monitorar</button>
            </div>

            <div class="flex-grow overflow-y-auto p-5 bg-slate-50 relative">
                <div id="loading" class="loader-overlay absolute inset-0 z-50 hidden flex flex-col items-center justify-center text-slate-600">
                    <i class="fas fa-circle-notch fa-spin text-3xl text-blue-600 mb-3"></i><span>Sincronizando...</span>
                </div>

                <!-- VIEW: PLANEJAR -->
                <div id="view-planning" class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase">Selecione o Motorista</h3>
                    <div id="drivers-grid" class="grid grid-cols-2 gap-2"></div>

                    <!-- Painel de Rota -->
                    <div id="planning-panel" class="hidden bg-white rounded-xl shadow border border-blue-100 overflow-hidden mt-4">
                        <div class="bg-blue-600 p-3 text-white flex justify-between items-center">
                            <span id="p-driver-name" class="font-bold">Motorista</span>
                            <button onclick="closePlanning()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-4 space-y-3">
                            <input id="p-dest" type="text" class="w-full p-2 border rounded text-sm" placeholder="Ex: *Cliente X* Rua Tal..." onkeypress="if(event.key === 'Enter') addRoute()">
                            <button onclick="addRoute()" class="w-full bg-slate-800 text-white py-2 rounded text-sm font-bold">Enviar para Celular</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW: LISTA -->
                <div id="view-list" class="hidden space-y-4">
                    <div id="fleet-container"></div>
                </div>
            </div>
        </aside>

        <main id="map-wrapper"><div id="map" class="w-full h-full"></div></main>
    </div>

    <script>
        // --- COLE SUA CONFIGURAÇÃO DO FIREBASE AQUI (Do Passo 1) ---
        const firebaseConfig = {

  apiKey: "AIzaSyDTMD5dV9gOGv3bnlbijjUW7322Wl8G7uU",

  authDomain: "sgc-logistica.firebaseapp.com",

  projectId: "sgc-logistica",

  storageBucket: "sgc-logistica.firebasestorage.app",

  messagingSenderId: "919635812656",

  appId: "1:919635812656:web:4ba91db3c511ff109168f5"

};
        // -----------------------------------------------------------

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Configurações
        const BASE_COORDS = { lat: -8.169, lon: -34.937 }; // Marcos Freire
        const DRIVERS = ["MARIO", "CLEITON", "MESSIAS", "MARCELO ANDRE", "JAMERSON", "MANSUETO", "JOAO VICTOR", "LUIZ RODRIGUES", "JONES", "EMERSON", "JOZY ALMIR", "JACKSON", "ROBERTO CARLOS", "ERIC", "RODRIGO", "CLOVIS", "JOELITON JACKSON"];
        
        let map, layerGroup;
        let selectedDriver = null;
        let allTrips = []; // Guarda todas as rotas vindas do banco

        // Inicialização
        window.onload = () => {
            initMap();
            loadRealtimeData();
            renderDriversGrid();
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([BASE_COORDS.lat, BASE_COORDS.lon], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            layerGroup = L.layerGroup().addTo(map);
        }

        // --- SISTEMA EM TEMPO REAL (O Coração) ---
        function loadRealtimeData() {
            document.getElementById('loading').classList.remove('hidden');
            
            // "Escuta" o banco de dados. Se algo mudar lá, atualiza aqui na hora.
            db.collection("entregas").orderBy("timestamp", "asc").onSnapshot((snapshot) => {
                allTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderDriversGrid(); // Atualiza contadores
                renderList();        // Atualiza lista detalhada
                
                if(selectedDriver) visualizeDriver(selectedDriver); // Atualiza mapa se tiver focado
                
                document.getElementById('loading').classList.add('hidden');
            });
        }

        async function addRoute() {
            const destInput = document.getElementById('p-dest');
            const rawDest = destInput.value.trim();
            if (!selectedDriver || !rawDest) return;

            document.getElementById('loading').classList.remove('hidden');

            // 1. Achar coordenadas
            const match = rawDest.match(/\*(.*?)\*/);
            const cleanAddr = match ? rawDest.replace(match[0], '').trim() : rawDest;
            const customName = match ? match[1].trim() : null;

            const coords = await getCoords(cleanAddr);
            if(!coords) { alert("Endereço não achado"); document.getElementById('loading').classList.add('hidden'); return; }

            // 2. Definir Origem (Base ou ultima entrega)
            const driverTrips = allTrips.filter(t => t.motorista === selectedDriver);
            const start = driverTrips.length > 0 ? driverTrips[driverTrips.length-1].destino : BASE_COORDS;

            // 3. Roteirizar
            const route = await getRouteOSRM(start, coords);
            
            // 4. Salvar no Firebase (O Motorista receberá instantaneamente)
            await db.collection("entregas").add({
                motorista: selectedDriver,
                origem: start,
                destino: { lat: coords.lat, lon: coords.lon, texto: coords.text, nome: customName },
                geometry: route ? route.geometry : null,
                distancia: route ? route.distance : 0,
                status: 'pendente', // pendente ou concluido
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            destInput.value = '';
            // Não precisa atualizar UI manualmente, o onSnapshot fará isso
        }

        function deleteTrip(id) {
            if(confirm("Apagar esta entrega?")) {
                db.collection("entregas").doc(id).delete();
            }
        }

        // --- UI & MAPA ---
        function renderDriversGrid() {
            const grid = document.getElementById('drivers-grid');
            grid.innerHTML = '';
            
            DRIVERS.forEach(name => {
                const count = allTrips.filter(t => t.motorista === name && t.status === 'pendente').length;
                const div = document.createElement('div');
                div.className = `driver-card p-2 border rounded cursor-pointer hover:shadow flex items-center gap-2 ${selectedDriver===name ? 'selected' : 'bg-white'}`;
                div.onclick = () => openPlanning(name);
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold">${name.charAt(0)}</div>
                    <div class="overflow-hidden">
                        <div class="font-bold text-xs truncate">${name}</div>
                        <div class="text-[10px] ${count > 0 ? 'text-blue-600 font-bold' : 'text-slate-400'}">${count} pendentes</div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function renderList() {
            const container = document.getElementById('fleet-container');
            container.innerHTML = '';
            
            // Agrupa por motorista
            const activeDrivers = [...new Set(allTrips.map(t => t.motorista))];

            activeDrivers.forEach(name => {
                const trips = allTrips.filter(t => t.motorista === name);
                const div = document.createElement('div');
                div.className = "bg-white rounded shadow-sm border mb-3 overflow-hidden";
                div.innerHTML = `
                    <div class="p-3 bg-slate-50 border-b flex justify-between" onclick="openPlanning('${name}')">
                        <span class="font-bold text-sm">${name}</span>
                        <span class="text-xs text-slate-500">${trips.length} rotas</span>
                    </div>
                    <div class="p-3">
                        ${trips.map((t, i) => `
                            <div class="timeline-item">
                                <div class="timeline-dot ${t.status === 'concluido' ? 'completed' : ''}"></div>
                                <div class="flex justify-between items-start ${t.status === 'concluido' ? 'opacity-50' : ''}">
                                    <div>
                                        <div class="font-bold text-xs text-blue-900">${t.destino.nome || 'Entrega ' + (i+1)}</div>
                                        <div class="text-xs text-slate-600 truncate w-48">${t.destino.texto}</div>
                                    </div>
                                    <button onclick="deleteTrip('${t.id}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openPlanning(name) {
            selectedDriver = name;
            renderDriversGrid();
            document.getElementById('planning-panel').classList.remove('hidden');
            document.getElementById('p-driver-name').innerText = name;
            visualizeDriver(name);
            document.getElementById('p-dest').focus();
        }

        function closePlanning() {
            selectedDriver = null;
            document.getElementById('planning-panel').classList.add('hidden');
            renderDriversGrid();
            layerGroup.clearLayers();
        }

        function visualizeDriver(name) {
            layerGroup.clearLayers();
            const trips = allTrips.filter(t => t.motorista === name);
            
            // Desenhar rotas
            const latlngs = [];
            trips.forEach((t, i) => {
                if(t.geometry) {
                    const path = t.geometry.coordinates.map(c => [c[1], c[0]]);
                    L.polyline(path, { color: t.status === 'concluido' ? '#10b981' : '#3b82f6' }).addTo(layerGroup);
                    latlngs.push(...path);
                }
                const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="w-6 h-6 ${t.status === 'concluido' ? 'bg-green-500' : 'bg-white border-2 border-slate-500'} rounded-full flex items-center justify-center text-xs font-bold">${i+1}</div>` });
                L.marker([t.destino.lat, t.destino.lon], {icon}).addTo(layerGroup).bindPopup(t.destino.nome || t.destino.texto);
            });

            // Caminhão (Ultima posição ou base)
            const lastPos = trips.length ? trips[trips.length-1].destino : BASE_COORDS;
            const truckIcon = L.divIcon({ className: 'custom-div-icon', html: `<div class="w-8 h-8 bg-blue-600 rounded-full border-2 border-white shadow flex items-center justify-center text-white"><i class="fas fa-truck text-xs"></i></div>` });
            L.marker([lastPos.lat, lastPos.lon], {icon: truckIcon}).addTo(layerGroup).bindPopup(name).openPopup();

            if(latlngs.length) map.fitBounds(latlngs, { padding: [50, 50] });
            else map.setView([BASE_COORDS.lat, BASE_COORDS.lon], 13);
        }

        function switchTab(id) {
            document.getElementById('view-planning').classList.toggle('hidden', id !== 'planning');
            document.getElementById('view-list').classList.toggle('hidden', id !== 'list');
        }

        // --- API HELPERS ---
        async function getCoords(addr) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&countrycodes=br&limit=1`);
                const data = await res.json();
                return data[0] ? { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), text: data[0].display_name.split(',')[0] } : null;
            } catch { return null; }
        }
        async function getRouteOSRM(start, end) {
            try {
                const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${start.lon},${start.lat};${end.lon},${end.lat}?overview=full&geometries=geojson`);
                const data = await res.json();
                return data.routes[0];
            } catch { return null; }
        }
    </script>
</body>
</html>