<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC - Painel Admin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; background-color: #f3f4f6; }
        #app-container { display: flex; height: 100vh; width: 100vw; }
        #sidebar { width: 400px; background: white; display: flex; flex-direction: column; border-right: 1px solid #e5e7eb; z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.05); }
        #map-wrapper { flex-grow: 1; position: relative; z-index: 10; }
        .custom-div-icon i { position: absolute; width: 22px; left: 0; right: 0; margin: 10px auto; text-align: center; font-size: 22px; }
        .driver-card.selected { border-color: #3b82f6; background-color: #eff6ff; }
        .loader-overlay { background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="app-container">
        <aside id="sidebar">
            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg"><i class="fas fa-satellite-dish"></i></div>
                    <div><h1 class="font-bold text-slate-800 text-lg">SGC - Gestão</h1><p class="text-xs text-green-600 font-bold">● Conectado</p></div>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto p-5 bg-slate-50 relative">
                <div id="loading" class="loader-overlay absolute inset-0 z-50 hidden flex flex-col items-center justify-center text-slate-600">
                    <i class="fas fa-circle-notch fa-spin text-3xl text-blue-600 mb-3"></i><span>Sincronizando...</span>
                </div>

                <!-- Lista de Motoristas -->
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Frota Disponível</h3>
                <div id="drivers-grid" class="grid grid-cols-2 gap-2 mb-4"></div>

                <!-- Painel de Adicionar Rota (Só aparece ao clicar no motorista) -->
                <div id="planning-panel" class="hidden bg-white rounded-xl shadow border border-blue-100 overflow-hidden mb-6">
                    <div class="bg-blue-600 p-3 text-white flex justify-between items-center">
                        <span id="p-driver-name" class="font-bold">...</span>
                        <button onclick="closePlanning()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="text-xs text-slate-500 bg-slate-50 p-2 rounded border border-slate-100">
                            <i class="fas fa-map-marker-alt text-red-500"></i> Origem: <strong id="p-origin" class="text-slate-800">Base</strong>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Novo Destino</label>
                            <input id="p-dest" type="text" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: *Cliente A* Rua da Aurora, 100" onkeypress="if(event.key === 'Enter') addRoute()">
                        </div>
                        <button onclick="addRoute()" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded text-sm font-bold shadow transition transform active:scale-95">
                            <i class="fas fa-paper-plane mr-1"></i> Enviar Rota
                        </button>
                    </div>
                </div>

                <!-- Lista de Entregas Recentes do Motorista Selecionado -->
                <div id="driver-trips-list" class="space-y-2 hidden">
                    <h3 class="text-xs font-bold text-slate-400 uppercase">Fila de Entregas</h3>
                    <div id="trips-container"></div>
                </div>
            </div>
        </aside>
        <main id="map-wrapper"><div id="map" class="w-full h-full"></div></main>
    </div>

    <script>
        // --- CONFIGURAÇÃO DO SEU FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTMD5dV9gOGv3bnlbijjUW7322Wl8G7uU",
            authDomain: "sgc-logistica.firebaseapp.com",
            projectId: "sgc-logistica",
            storageBucket: "sgc-logistica.firebasestorage.app",
            messagingSenderId: "919635812656",
            appId: "1:919635812656:web:4ba91db3c511ff109168f5"
        };
        
        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const BASE = { lat: -8.169, lon: -34.937, text: "Marcos Freire, Jaboatão" };
        const DRIVERS = ["MARIO", "CLEITON", "MESSIAS", "MARCELO ANDRE", "JAMERSON", "MANSUETO", "JOAO VICTOR", "LUIZ RODRIGUES", "JONES", "EMERSON", "JOZY ALMIR", "JACKSON", "ROBERTO CARLOS", "ERIC", "RODRIGO", "CLOVIS", "JOELITON JACKSON"];
        
        let map, layerGroup, selectedDriver = null, allTrips = [];

        window.onload = () => {
            map = L.map('map', {zoomControl: false}).setView([BASE.lat, BASE.lon], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            layerGroup = L.layerGroup().addTo(map);
            
            // Listener em tempo real
            db.collection("entregas").orderBy("timestamp", "asc").onSnapshot(snapshot => {
                allTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGrid();
                if(selectedDriver) updatePanel();
            }, error => {
                console.error("Erro ao conectar no Firebase:", error);
                alert("Erro de conexão. Verifique o console.");
            });
        };

        function renderGrid() {
            const grid = document.getElementById('drivers-grid');
            grid.innerHTML = '';
            DRIVERS.sort().forEach(name => {
                const pending = allTrips.filter(t => t.motorista === name && t.status === 'pendente').length;
                const div = document.createElement('div');
                div.className = `driver-card p-2 border rounded cursor-pointer hover:shadow flex items-center gap-2 transition ${selectedDriver===name ? 'selected' : 'bg-white'}`;
                div.onclick = () => openPlanning(name);
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full ${pending > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-400'} flex items-center justify-center text-xs font-bold">${name.charAt(0)}</div>
                    <div class="overflow-hidden">
                        <div class="font-bold text-[11px] truncate text-slate-700">${name}</div>
                        <div class="text-[10px] ${pending > 0 ? 'text-blue-600 font-bold' : 'text-slate-400'}">${pending} pendentes</div>
                    </div>`;
                grid.appendChild(div);
            });
        }

        function openPlanning(name) {
            selectedDriver = name;
            document.getElementById('planning-panel').classList.remove('hidden');
            document.getElementById('driver-trips-list').classList.remove('hidden');
            document.getElementById('p-driver-name').innerText = name;
            renderGrid();
            updatePanel();
            setTimeout(() => document.getElementById('p-dest').focus(), 100);
        }

        function closePlanning() {
            selectedDriver = null;
            document.getElementById('planning-panel').classList.add('hidden');
            document.getElementById('driver-trips-list').classList.add('hidden');
            renderGrid();
            layerGroup.clearLayers();
        }

        function updatePanel() {
            if(!selectedDriver) return;
            const trips = allTrips.filter(t => t.motorista === selectedDriver);
            const lastTrip = trips.length ? trips[trips.length-1].destino : BASE;
            
            // Atualiza texto da origem no painel
            document.getElementById('p-origin').innerText = (lastTrip.nome || lastTrip.texto || "Base").substring(0, 35) + "...";

            // Mapa
            layerGroup.clearLayers();
            const latlngs = [];
            
            // Desenha a Base
            L.marker([BASE.lat, BASE.lon]).addTo(layerGroup).bindPopup("<b>Base SGC</b><br>Marcos Freire").openPopup();

            trips.forEach((t, i) => {
                if(t.geometry) {
                    const linePoints = t.geometry.coordinates.map(c=>[c[1],c[0]]);
                    L.polyline(linePoints, {
                        color: t.status==='concluido'?'#10b981':'#3b82f6',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(layerGroup);
                    latlngs.push(...linePoints);
                }
                const color = t.status === 'concluido' ? 'green' : 'blue';
                const icon = L.divIcon({className: 'custom-div-icon', html: `<div class="w-6 h-6 bg-${color}-500 border-2 border-white text-white rounded-full flex items-center justify-center text-xs shadow-md font-bold">${i+1}</div>`});
                L.marker([t.destino.lat, t.destino.lon], {icon}).addTo(layerGroup).bindPopup(`<b>${t.destino.nome || 'Entrega'}</b><br>${t.destino.texto}`);
            });
            
            if(latlngs.length > 0) map.fitBounds(latlngs, {padding: [50, 50]});
            else map.setView([BASE.lat, BASE.lon], 14);
            
            // Lista recente
            const list = document.getElementById('trips-container');
            if(trips.length === 0) {
                list.innerHTML = '<p class="text-xs text-slate-400 text-center py-4">Nenhuma rota atribuída.</p>';
            } else {
                list.innerHTML = trips.map((t, i) => `
                    <div class="bg-white p-3 border rounded-lg flex justify-between items-start text-xs shadow-sm hover:shadow-md transition group">
                        <div>
                            <div class="flex items-center gap-1 mb-1">
                                <span class="bg-slate-100 text-slate-500 font-bold px-1.5 rounded-sm">${i+1}</span>
                                <span class="font-bold ${t.status==='concluido'?'text-green-600':'text-blue-700'}">${t.destino.nome || 'Entrega'}</span>
                            </div>
                            <div class="text-slate-500 truncate w-40" title="${t.destino.texto}">${t.destino.texto}</div>
                        </div>
                        <div class="flex flex-col gap-2 items-end">
                            <span class="${t.status==='concluido'?'text-green-500':'text-orange-400'} text-[10px] font-bold uppercase">
                                ${t.status}
                            </span>
                            <button onclick="deleteTrip('${t.id}')" class="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function addRoute() {
            const input = document.getElementById('p-dest');
            const raw = input.value.trim();
            if(!raw || !selectedDriver) return;
            
            document.getElementById('loading').classList.remove('hidden');
            
            // Parse texto (*Nome* Endereço)
            const match = raw.match(/\*(.*?)\*/);
            const addr = match ? raw.replace(match[0], '').trim() : raw;
            const nome = match ? match[1].trim() : null;

            // API Calls
            try {
                // 1. Geocodificação
                const resGeo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&countrycodes=br&limit=1`);
                const dataGeo = await resGeo.json();
                if(!dataGeo.length) throw new Error("Endereço não encontrado.");
                
                const dest = { lat: parseFloat(dataGeo[0].lat), lon: parseFloat(dataGeo[0].lon), texto: dataGeo[0].display_name.split(',')[0], nome };
                
                // 2. Roteirização (Da ultima parada ou base)
                const driverTrips = allTrips.filter(t => t.motorista === selectedDriver);
                const start = driverTrips.length ? driverTrips[driverTrips.length-1].destino : BASE;

                const resRoute = await fetch(`https://router.project-osrm.org/route/v1/driving/${start.lon},${start.lat};${dest.lon},${dest.lat}?overview=full&geometries=geojson`);
                const dataRoute = await resRoute.json();
                
                // 3. Salvar no Firestore
                await db.collection("entregas").add({
                    motorista: selectedDriver,
                    origem: start,
                    destino: dest,
                    geometry: dataRoute.routes[0]?.geometry,
                    status: 'pendente',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                input.value = '';
            } catch(e) {
                alert("Erro: " + e.message);
            }
            document.getElementById('loading').classList.add('hidden');
        }

        function deleteTrip(id) {
            if(confirm("Tem certeza que deseja apagar esta entrega?")) db.collection("entregas").doc(id).delete();
        }
    </script>
</body>
</html>
